SKA CICD Gitlab K8s Agents Config
=================================

This repository stores the Gitlab K8s Agents configuration files, which connects the Kubernetes clusters infrastructures with Gitlab and allows the respective KUBECONFIG files to be injected into the pipelines.

How it works
------------

The GitLab Agent for Kubernetes (agentk) communicates to the GitLab Agent Server (KAS) to perform GitOps operations.

KAS is responsible for:
*Accepting requests from agentk
*Authentication of requests from agentk by querying GitLab RoR
*Fetching the agent's configuration from a corresponding Git repository by querying Gitaly
*Matching incoming requests from GitLab connection acceptor with existing connections from the right agentk, forwarding requests to it, and forwarding responses back
*Polling manifest repositories for GitOps support by communicating with Gitaly

Location of this config repository
----------------------------------

Currently we are restricted to having the configuration files in a repo at
the root of the SKAO repositories, placing it in a subgroup like sdi would
prevent access to repositories outside of that subgroup. This is really a feature not a
bug:

<https://gitlab.com/gitlab-org/gitlab/-/merge_requests/69047#note_671995017>

It may change in the near feature.

Adding and configuring new agents
---------------------------------

To add new agents, a configuration file must be created in the following location in this repository: `.gitlab/agents/<agent-name>/config.yaml`. It is important to make sure the file extension is `.yaml` since `.yml` is not accepted. Projects need to
be added individually (access to whole groups is also possible).

Example of configuration for psilow

```yaml
gitops:
  manifest_projects:
  - id: ska-telescope/ska-cicd-gitlab-k8s-agents-config
    paths:
    - glob: '/manifests/psi-low/*.yaml'
ci_access:
  projects:
  - id: ska-telescope/sdi/ska-cicd-stencil
  - id: ska-telescope/ska-low-cbf
```

After this file is added, the agent can be registered in the `Kubernetes clusters` page under `Infrastructure` on the side panel of this repository. After the agent is registered, a token will be displayed with instructions on how to install the agent on the target Kubernetes cluster.

With the token, the `generate-agent-manifest` make target can be used to generate the agent manifest file (requires docker to be installed). The following environment variables are used for this step:

```console
AGENT_TOKEN=... # The agent access token obtained from Gitlab upon registration (Required)
AGENT_KAS_ADDRESS=... # The Kubernetes Agent Server address. Defaults to `wss://kas.gitlab.com` and should work for the `gitlab.com` instance.
AGENT_VERSION=... # The agent version to install. Defaults to `14.7.0`.
NAMESPACE=... # The kubernetes namespace to install the agent to. Defaults to `gitlab`.
```

After the manifest file has been generated (and modified if necessary, such as to add proxy configurations), run `make agent` to deploy it.

For more information, see the [Gitlab documentation](https://docs.gitlab.com/ee/user/clusters/agent/repository.html#agent-configuration-repository) on how to configure the agent repository.

By the default, the command generated by gitlab sets up a service account with cluster-admin rights, giving full
unrestricted access. This can be changed by setting roles and bindings with stricter permissions and applying
those to the agentk pod. Creating Roles and RoleBindings manually for each namespace is relatively straightforward
but unpractical if using generated namespaces.

Even the full unrestricted service account failed with current pipeline machinery.

Impersonation
-------------

<https://docs.gitlab.com/ee/user/clusters/agent/ci_cd_tunnel.html#use-impersonation-to-restrict-project-and-group-access>

Another possibility for access restrictions is impersonation, as a job or static user. Example of impersonation as a job
for the psilow manifest shown above:

```yaml
ci_access:
  projects:
  - id: ska-telescope/ska-low-cbf
    access_as:
      ci_job: {}
  - id: ska-telescope/ska-low-cbf
    access_as:
      ci_job: {}
```

Again, it didn't really work with current pipeline machinery.

Issues
------

Partial success was obtained for unrestricted access when context was explicit
and environment configuration was changed.

test agent
<https://gitlab.com/ska-telescope/ska-low-cbf/-/commit/20190267e445d6b593425e9bbc3abebac3f763c2>

test without environment
<https://gitlab.com/ska-telescope/ska-low-cbf/-/commit/8c81db831c4dc55f875a5533e5c8d1b81fe3c62c>

Set KUBE_CONTEXT for the jobs.
<https://gitlab.com/ska-telescope/ska-low-cbf/-/commit/60f4e04ed7964e6d882afdc891565d7a1b998c6a>

Although deployments were possible, for the agent to be an alternative for psilow it
will require changing the way we handle k8s in the pipeline
(or add new behavior based on a tag with "agentk-" in the name).

GitLab Runner Manifests
-----------------------

The GitLab Runner Manifests when deployed through the agent requires certain secrets to be deployed on the cluster for the runner to successfully register and use the MinIO Cache.

To simplify this process, the `agent-runner-secrets` make target was created which deploys the necessary secrets. This make target requires the following environment variables to be set:

```console
MINIO_USERNAME=... # The MinIO Access Key for GitLab Runners
MINIO_PASSWORD=... # The MinIO Secret Key for GitLab Runners
RUNNER_REGISTRATION_TOKEN=... # The runner registration token.
NAMESPACE=... # The kubernetes namespace to install the secrets to. Defaults to `gitlab`.
```
